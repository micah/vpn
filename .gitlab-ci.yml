stages:
  - build_image
  - build
  - test
  - publish

variables:
  # When using dind, it's wise to use the overlayfs driver for
  # improved performance.
  DOCKER_DRIVER: overlay
  GITLAB_ADVANCED_SAST_ENABLED: 'true'
  DS_GRADLE_RESOLUTION_POLICY: 'none'

include:
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml

build-docker-image:
  variables:
    TAG: main # non-tag build will be unset, set to 'latest' in script
  stage: build_image
  image:
    name: "containers.torproject.org/tpo/tpa/base-images/podman:bookworm"
  script:
    - export TMPDIR=$(pwd)/.tmp
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - podman build -t ${CI_REGISTRY_IMAGE}:${TAG} .
    - podman push ${CI_REGISTRY_IMAGE}:${TAG}
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - when: never

# Basic android and gradle stuff
# Check linting
lintDebug:
  image: "containers.torproject.org/tpo/applications/vpn:main"
  interruptible: true
  stage: test
  script:
    - ./gradlew -Pci --console=plain :app:lintDebug -PbuildDir=lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always

# Make Project
assembleDebug:
  image: "containers.torproject.org/tpo/applications/vpn:main"
  interruptible: true
  stage: build
  script:
    - curl -s https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer | bash
    - ./gradlew clean assembleDebug --stacktrace
  artifacts:
    paths:
      - app/build/outputs/
      - build.log
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always

# Publish apk
publish:
  image: "containers.torproject.org/tpo/applications/vpn:main"
  stage: publish
  rules:
    # Skip this job in scheduled pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Run when a tag is created
    - if: $CI_COMMIT_TAG
      variables:
        TAG: "${CI_COMMIT_TAG}"
    # Run when commits are pushed or merged to the default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        TAG: "main"
  dependencies: 
    - assembleDebug
  script:
    - 'echo "Pushing apk with tag: ${TAG} to gitlab package area"'
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file app/build/outputs/apk/debug/app-debug.apk "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/org.torproject.vpn.testing/${TAG}/tor-vpn-debug.apk"'

# Run all tests, if any fails, interrupt the pipeline(fail it)
debugTests:
  image: "containers.torproject.org/tpo/applications/vpn:main"
  interruptible: true
  stage: test
  script:
    - ./gradlew -Pci --console=plain :app:testDebug
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always
